---
title: Internals
---

Key to the partial hydration is the `island` function, which is provided through a virtual module.
Depending on whether the build is performed in client or server mode, a different implementation is returned.

For client builds, the island function is a no-op, it returns the passed-in component verbatim.

For server builds, the function returns a higher order component that renders a fragment:
The original component followed by a script tag.

## Island marker script

The island marker script is of type `application/json` and contains the component's initial props,
serialized as JSON. It also has a `data-island` attribute that identifies the component.
The value is the moduleId of the component's rollup chunk.

```html
<div data-island-root style="display: contents;">
  <div class="counter"><button>-</button>100<button>+</button></div>
  <script
    type="application/json"
    data-island="/src/Counter.island.tsx"
    data-key="Counter"
  >
    {
      "start": 100
    }
  </script>
</div>
```

In order to obtain this ID, the island module calls `import.meta.globEager()` to find all components that match
the configured glob pattern. It then compares the passed component to all found island
components (using a `===` check).

During the client-build, a hydration script is emitted that calls `import.meta.glob()` with the configured
pattern and instead of its eager counterpart, this yields a list of dynamic imports.

The rest is a matter of finding all hydration marker scripts in the DOM and hydrating their preceding siblings.

## Framework adapters

Currently, Capri ships with three framework adapters. Take a look at the sources to see how they are implemented:

- React: [@capri-js/react](https://github.com/capri-js/capri/tree/main/packages/react)
- Preact: [@capri-js/preact](https://github.com/capri-js/capri/tree/main/packages/preact)
- SolidJS: [@capri-js/solid](https://github.com/capri-js/capri/tree/main/packages/solid)

This is what the React implemenation looks like:

```ts
// @capri-js/react/src/index.ts

import capri, { CapriAdapterPluginOptions } from "@capri-js/vite-plugin";

export default function (opts: CapriAdapterPluginOptions = {}) {
  return capri({
    ...opts,
    hydrate: "@capri-js/react/lib/hydrate.js",
    renderMarkerFragment: "@capri-js/react/lib/renderMarkerFragment.js",
  });
}
```

As you can see, the plugin is just a thin wrapper around `@capri-js/vite-plugin` that
injects two options: `hydrate` and `renderMarkerFragment`.

Lets take a look at `hydrate` first:

```ts
// @capri-js/react/src/hydrate.ts

import { ComponentType, createElement } from "react";
import { hydrateRoot } from "react-dom/client";

export function hydrate(
  component: ComponentType,
  props: object,
  element: Element
) {
  return hydrateRoot(element.parentElement!, createElement(component, props));
}
```

All hydration module must export a `hydrate` function with the signature above that
invokes the framework specific hydration code.

Finally, we need to implement the code that renders the island, followed by the
[marker script](#island-marker-script):

```ts
// @capri-js/react/src/renderMarkerFragement.ts

import { ComponentType, createElement } from "react";

export function renderMarkerFragment(
  Component: ComponentType,
  props: object,
  scriptProps: object,
  scriptContent: string
) {
  // In order to hydrate a React component it must be the first child element.
  // To guarantee this, we wrap it in an extra div and set it to
  // `display: contents` in order to not affect the styling.
  return createElement(
    "div",
    { "data-island-root": true, style: { display: "contents" } },
    createElement(Component, props),
    createElement("script", {
      ...scriptProps,
      dangerouslySetInnerHTML: { __html: scriptContent },
    })
  );
}
```
